angular.module("harrie.mdeditor",[]).config(function(){if(angular.isUndefined(window.CodeMirror))throw new Error("Require CodeMirror!");String.prototype.startWith=function(t,e){var n="undefined"!=typeof e&&e?this.trim():this;return"string"==typeof t&&n.length>=t.length&&n.substr(0,t.length)===t},String.prototype.endWith=function(t,e){var n="undefined"!=typeof e&&e?this.trim():this;return"string"==typeof t&&n.length>=t.length&&n.substr(n.length-t.length)===t}}).constant("mdeditorConfig",{classNames:{wrapper:"mdeditor",toolbar:"mdeditor-toolbar",toolbarItem:"mdeditor-toolbar-item",separator:"mdeditor-toolbar-separator",textarea:"mdeditor-textarea",preview:"mdeditor-preview"},toolbar:[{action:"bold",icon:"fa fa-bold",tip:"加粗(Ctrl+B)"},{action:"italic",icon:"fa fa-italic",tip:"斜体(Ctrl+I)"},{action:"header",icon:"fa fa-header",tip:"标题(Ctrl+H)"},{separator:!0},{action:"ul",icon:"fa fa-list-ul",tip:"无序列表(Ctrl+U)"},{action:"ol",icon:"fa fa-list-ol",tip:"有序列表(Ctrl+O)"},{action:"code",icon:"fa fa-code",tip:"代码(Ctrl+K)"},{action:"quote",icon:"fa fa-quote-left",tip:"引用(Ctrl+Q)"},{separator:!0},{action:"link",icon:"fa fa-link",tip:"连接(Ctrl+L)"},{action:"img",icon:"fa fa-picture-o",tip:"图片(Ctrl+G)"},{separator:!0},{action:"undo",icon:"fa fa-undo",tip:"撤销"},{action:"redo",icon:"fa fa-repeat",tip:"重做"},{action:"preview",icon:"fa fa-eye",tip:"浏览"},{action:"fullscreen",icon:"fa fa-arrows-alt",tip:"全屏"}],shortcut:{"Ctrl-B":"bold","Ctrl-I":"italic","Ctrl-H":"header","Ctrl-U":"ul","Ctrl-O":"ol","Ctrl-K":"code","Ctrl-Q":"quote","Ctrl-L":"link","Ctrl-G":"img"}}).factory("actions",[function(){function t(t,e,i){var r=t.getSelections(),o=[],a=n[e].prefix,l=n[e].postfix;r.forEach(function(t){t.length>=a.length+l.length&&t.startWith(a,i)&&t.endWith(l)?o.push(t.substr(a.length,t.length-a.length-l.length)):o.push(a+t+l)}),t.replaceSelections(o,"around")}function e(t,e){var i=t.listSelections();i.forEach(function(e){var n=e.anchor.line,i=e.head.line,r=i>n?n:i,o=n>i?n:i;t.addSelection({line:r,ch:0},{line:o})});var r=n[e].prefix,o=[];i=t.getSelections(),i.forEach(function(t){o.push(t.split("\n").map(function(t){if(t.startWith(r,!0)){var e=t.indexOf(r);return startChars=t.substr(0,e),endChars=t.substr(e+r.length),startChars+endChars}return r+t}).join("\n"))}),t.replaceSelections(o,"around")}var n={bold:{prefix:"**",postfix:"**"},italic:{prefix:"_",postfix:"_"},code:{prefix:"```\n",postfix:"\n```"},link:{prefix:"[",postfix:"](src)"},img:{prefix:"![",postfix:"](src)"},header:{prefix:"### ",postfix:""},quote:{prefix:"> ",postfix:""},ul:{prefix:"- ",postfix:""}};return{bold:function(e){t(e,"bold")},italic:function(e){t(e,"italic")},code:function(e){t(e,"code")},link:function(e){t(e,"link")},img:function(e){t(e,"img")},header:function(t){e(t,"header")},quote:function(t){e(t,"quote")},ul:function(t){e(t,"ul")},ol:function(t){var e=t.listSelections();e.forEach(function(e){var n=e.anchor.line,i=e.head.line,r=i>n?n:i,o=n>i?n:i;t.addSelection({line:r,ch:0},{line:o})});var n=[];e=t.getSelections(),e.forEach(function(t){/^\s*\d+\.\s/m.test(t)?n.push(t.replace(/^\s*\d+\.\s/gm,"")):n.push(t.split("\n").map(function(t,e){return e+1+". "+t}).join("\n"))}),t.replaceSelections(n,"around")},undo:function(t){t.undo()},redo:function(t){t.redo()}}}]).provider("hljsServ",function(){var t={};return{setOptions:function(e){angular.extend(t,e)},getOptions:function(){return angular.copy(t)},$get:function(){return hljs.configure(t),hljs}}}).filter("markdown",["$sce","hljsServ",function(t,e){var n=window.marked&&function(t){return t}(window.marked)||window.showdown&&function(t){var e=new t.Converter({parseImgDimensions:!0,simplifiedAutoLink:!0,literalMidWordUnderscores:!0,strikethrough:!0,tables:!0,ghCodeBlocks:!0,tasklists:!0});return e.makeHtml.bind(e)}(window.showdown)||function(t){return t};return function(i){return t.trustAsHtml(n(i).replace(/(<pre[^>]*><code[^>]*>)(.|\n)*?(<\/code><\/pre>)/g,function(t){var n=angular.element(t),i=n.children().addClass("hljs");return i.html(e.highlightAuto(i.text()).value),n[0].outerHTML}))}}]).directive("mdeditor",["mdeditorConfig","actions",function(t,e){return{restrict:"AE",scope:{text:"=",options:"=",classNames:"=",toolbar:"=",shortcut:"="},template:['<div class="{{classNames.wrapper}}">','<ul class="{{classNames.toolbar}}">','<li ng-repeat="item in toolbar | filter:toolbarFilter track by $index" ng-click="callAction(item.action)" class="{{item.separator?classNames.separator:classNames.toolbarItem}}" title="{{item.tip}}">','<i class="{{item.icon}}" ng-if="!item.separator"></i>','<span ng-if="item.separator">|</span>',"</li>","</ul>",'<textarea class="{{classNames.textarea}}" ng-show="!preview"></textarea>','<div class="{{classNames.preview}}" ng-bind-html="text | markdown" ng-if="preview"></div>',"</div>"].join(""),replace:!0,compile:function(n,i){var r=i.theme||"default",o=n.find("textarea"),a=new window.CodeMirror(function(t){angular.forEach(o.prop("attributes"),function(e){"class"==e.name?t.className+=" "+e.textContent:t.setAttribute(e.name,e.textContent)}),o.replaceWith(t)},{mode:"gfm",lineWrapping:!0,theme:r});return function(n,i,r){n.preview=!1,n.classNames=n.classNames||t.classNames,n.toolbar=n.toolbar||t.toolbar;var o=n.options||{};for(var l in o)a.setOption(l,o[l]);var s=n.shortcut||t.shortcut,c={};for(var l in s)"string"==typeof l&&e[s[l]]&&(c[l]=e[s[l]]);c.Enter="newlineAndIndentContinueMarkdownList",c.Tab="tabAndIndentContinueMarkdownList",c["Shift-Tab"]="shiftTabAndIndentContinueMarkdownList",a.setOption("extraKeys",c),n.callAction=function(t){if(t){if(e[t])e[t](a);else if("preview"==t)n.preview=!n.preview;else if("fullscreen"==t){var r=i[0],o=r.requestFullScreen||r.webkitRequestFullScreen||r.mozRequestFullScreen;o&&o.call(r)}a.focus()}},n.text&&a.setValue(n.text),a.on("change",function(t){var e=t.getValue();if(n.text!==e){n.text=t.getValue();var i=n.$root.$$phase;"$apply"!==i&&"digest"!==i&&n.$apply()}})}}}}]);